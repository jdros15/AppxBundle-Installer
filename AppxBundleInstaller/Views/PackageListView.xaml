<UserControl x:Class="AppxBundleInstaller.Views.PackageListView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.modernwpf.com/2019"
             xmlns:converters="clr-namespace:AppxBundleInstaller.Converters"
             Loaded="OnLoaded">
    
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility" />
        <converters:PackageTypeToStringConverter x:Key="PackageTypeToString" />
        <converters:PackageTypeToBrushConverter x:Key="PackageTypeToBrush" />
        <converters:LogoPathToImageSourceConverter x:Key="LogoPathToImage" />
        <converters:StringEmptyToVisibilityConverter x:Key="StringEmptyToVisibility" />
        <converters:StringNotEmptyToVisibilityConverter x:Key="StringNotEmptyToVisibility" />
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Grid Grid.Row="0" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            
            <TextBlock Text="Installed Apps" Style="{StaticResource SectionHeaderStyle}" Margin="0" />
            
            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <Button x:Name="ExportButton" Content="Export" Click="ExportButton_Click" Padding="16,8" Margin="0,0,8,0" />
                <Button x:Name="RefreshButton" Content="Refresh" Click="RefreshButton_Click" Padding="16,8" />
            </StackPanel>
        </Grid>
        
        <!-- Search Bar -->
        <Border Grid.Row="1" Style="{StaticResource CardStyle}" Margin="0,0,0,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                
                <TextBox x:Name="SearchBox" 
                         ui:ControlHelper.PlaceholderText="Search packages..."
                         TextChanged="SearchBox_TextChanged"
                         VerticalAlignment="Center"
                         FontSize="14" />
                
                <ComboBox x:Name="SortOrder" 
                          Grid.Column="1"
                          SelectedIndex="0"
                          SelectionChanged="SortOrder_SelectionChanged"
                          MinWidth="150"
                          Margin="12,0,0,0">
                    <ComboBoxItem Content="Name (A-Z)" />
                    <ComboBoxItem Content="Name (Z-A)" />
                    <ComboBoxItem Content="Recently Installed" />
                    <ComboBoxItem Content="Oldest First" />
                    <ComboBoxItem Content="Publisher" />
                    <ComboBoxItem Content="Version" />
                </ComboBox>
                
                <ComboBox x:Name="PublisherFilter" 
                          Grid.Column="2"
                          SelectedIndex="0"
                          SelectionChanged="PublisherFilter_SelectionChanged"
                          MinWidth="120"
                          Margin="12,0,0,0">
                    <ComboBoxItem Content="All" />
                    <ComboBoxItem Content="Microsoft" />
                    <ComboBoxItem Content="Third-Party" />
                </ComboBox>
                
                <CheckBox x:Name="ShowFrameworks"
                          Grid.Column="3"
                          Content="Frameworks"
                          Checked="Filter_Changed"
                          Unchecked="Filter_Changed"
                          Margin="12,0,0,0"
                          VerticalAlignment="Center" />
            </Grid>
        </Border>
        
        <!-- Loading -->
        <StackPanel x:Name="LoadingPanel" 
                    Grid.Row="2" 
                    HorizontalAlignment="Center" 
                    VerticalAlignment="Center"
                    Visibility="Collapsed">
            <ui:ProgressRing IsActive="True" Width="40" Height="40" />
            <TextBlock Text="Loading packages..." Margin="0,12,0,0" 
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
        </StackPanel>
        
        <!-- Package List -->
        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            
            <!-- Column Headers - Add right margin to account for scrollbar -->
            <Grid Grid.Row="0" Margin="12,0,28,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="44" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="90" />
                    <ColumnDefinition Width="120" />
                    <ColumnDefinition Width="60" />
                </Grid.ColumnDefinitions>
                
                <!-- Icon Column Placeholder (for alignment) -->
                <Border Grid.Column="0"
                        Visibility="{Binding DataContext.ShowAppIcons, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BoolToVisibility}}" />
                
                <TextBlock Grid.Column="1" Text="Name" 
                           FontWeight="SemiBold" FontSize="12"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                           Margin="8,0,0,0" />
                <TextBlock Grid.Column="2" Text="Type" 
                           FontWeight="SemiBold" FontSize="12"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                           HorizontalAlignment="Center" />
                <TextBlock Grid.Column="3" Text="Version" 
                           FontWeight="SemiBold" FontSize="12"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                           HorizontalAlignment="Center" />
                <TextBlock Grid.Column="4" Text="Arch" 
                           FontWeight="SemiBold" FontSize="12"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                           HorizontalAlignment="Center" />
            </Grid>
            
            <ListView x:Name="PackageList"
                      Grid.Row="1"
                      SelectionChanged="PackageList_SelectionChanged"
                      Background="Transparent"
                      BorderThickness="0"
                      HorizontalContentAlignment="Stretch"
                      ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                        <Setter Property="Padding" Value="12,0" />
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <Grid Margin="0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="44" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="90" />
                                <ColumnDefinition Width="120" />
                                <ColumnDefinition Width="60" />
                            </Grid.ColumnDefinitions>
                            
                            <!-- Icon - Shows app logo if available, otherwise fallback emoji -->
                            <Grid Grid.Column="0" Width="36" Height="36"
                                  Visibility="{Binding DataContext.ShowAppIcons, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BoolToVisibility}}">
                                <!-- Actual app icon when available -->
                                <Border CornerRadius="6"
                                        Visibility="{Binding LogoPath, Converter={StaticResource StringNotEmptyToVisibility}}">
                                    <Border.Background>
                                        <ImageBrush ImageSource="{Binding LogoPath, Converter={StaticResource LogoPathToImage}}"
                                                    Stretch="UniformToFill" />
                                    </Border.Background>
                                </Border>
                                
                                <!-- Fallback icon when no logo available -->
                                <Border Background="{DynamicResource SystemControlHighlightAccentBrush}"
                                        CornerRadius="6"
                                        Visibility="{Binding LogoPath, Converter={StaticResource StringEmptyToVisibility}}">
                                    <TextBlock Text="ðŸ“¦" FontSize="18" 
                                               HorizontalAlignment="Center" VerticalAlignment="Center" />
                                </Border>
                            </Grid>
                            
                            <!-- Name & Publisher -->
                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="8,0,16,0">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding DisplayName}" 
                                               FontWeight="SemiBold"
                                               TextTrimming="CharacterEllipsis"
                                               Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}" />
                                    <!-- System-Protected Icon -->
                                    <TextBlock Text="â›”" FontSize="11" Margin="6,0,0,0" 
                                               VerticalAlignment="Center"
                                               ToolTip="System-Protected Package - Windows considers this essential"
                                               Visibility="{Binding IsSystemProtected, Converter={StaticResource BoolToVisibility}}" />
                                    <!-- Critical App Warning Icon (only show if not already system-protected) -->
                                    <TextBlock Text="âš ï¸" FontSize="12" Margin="6,0,0,0" 
                                               VerticalAlignment="Center"
                                               ToolTip="Critical System App - Uninstalling may break Windows"
                                               Visibility="{Binding IsCriticalSystemApp, Converter={StaticResource BoolToVisibility}}" />
                                </StackPanel>
                                <TextBlock Text="{Binding PublisherDisplayName}" 
                                           FontSize="12"
                                           TextTrimming="CharacterEllipsis"
                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                            </StackPanel>
                            
                            <!-- Type Badge -->
                            <Border Grid.Column="2"
                                    Background="{Binding Type, Converter={StaticResource PackageTypeToBrush}}"
                                    CornerRadius="4"
                                    Padding="8,4"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center">
                                <TextBlock Text="{Binding Type, Converter={StaticResource PackageTypeToString}}"
                                           FontSize="11"
                                           FontWeight="SemiBold"
                                           Foreground="White" />
                            </Border>
                            
                            <!-- Version -->
                            <TextBlock Grid.Column="3" 
                                       Text="{Binding Version}"
                                       VerticalAlignment="Center"
                                       HorizontalAlignment="Center"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                            
                            <!-- Arch -->
                            <TextBlock Grid.Column="4"
                                       Text="{Binding Architecture}"
                                       VerticalAlignment="Center"
                                       HorizontalAlignment="Center"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>
        
        <!-- Selected Package Actions -->
        <Border x:Name="ActionPanel" 
                Grid.Row="3" 
                Style="{StaticResource CardStyle}"
                Visibility="Collapsed"
                Margin="0,16,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                
                <StackPanel>
                    <TextBlock x:Name="SelectedName" FontSize="14" FontWeight="SemiBold"
                               Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}" />
                    <TextBlock x:Name="SelectedFamily" FontSize="12"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                </StackPanel>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button x:Name="OpenLocationButton" Content="Open Location" 
                            Click="OpenLocation_Click" Padding="12,6" Margin="0,0,8,0" />
                    <Button x:Name="UninstallButton" Content="Uninstall" 
                            Click="Uninstall_Click" Padding="12,6"
                            Foreground="{StaticResource ErrorBrush}" />
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Status and Info -->
        <Grid Grid.Row="4" Margin="0,8,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            
            <TextBlock x:Name="StatusText" 
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
            
            <!-- Info Button -->
            <Button Grid.Column="1" 
                    Background="Transparent"
                    BorderThickness="0"
                    Padding="8,4"
                    ToolTipService.InitialShowDelay="0"
                    ToolTipService.ShowDuration="30000">
                <Button.ToolTip>
                    <ToolTip MaxWidth="350">
                        <StackPanel>
                            <TextBlock Text="Architecture Types" FontWeight="Bold" Margin="0,0,0,8" />
                            <TextBlock TextWrapping="Wrap" Margin="0,0,0,4">
                                <Run FontWeight="SemiBold">X64:</Run>
                                <Run>64-bit Intel/AMD processors</Run>
                            </TextBlock>
                            <TextBlock TextWrapping="Wrap" Margin="0,0,0,4">
                                <Run FontWeight="SemiBold">X86:</Run>
                                <Run>32-bit Intel/AMD processors</Run>
                            </TextBlock>
                            <TextBlock TextWrapping="Wrap" Margin="0,0,0,4">
                                <Run FontWeight="SemiBold">ARM64:</Run>
                                <Run>64-bit ARM processors (e.g., Snapdragon)</Run>
                            </TextBlock>
                            <TextBlock TextWrapping="Wrap" Margin="0,0,0,4">
                                <Run FontWeight="SemiBold">ARM:</Run>
                                <Run>32-bit ARM processors</Run>
                            </TextBlock>
                            <TextBlock TextWrapping="Wrap" Margin="0,0,0,4">
                                <Run FontWeight="SemiBold">Neutral:</Run>
                                <Run>Architecture-independent (works on all)</Run>
                            </TextBlock>
                            <TextBlock TextWrapping="Wrap">
                                <Run FontWeight="SemiBold">Any:</Run>
                                <Run>Can run on any architecture (universal)</Run>
                            </TextBlock>
                        </StackPanel>
                    </ToolTip>
                </Button.ToolTip>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="â„¹ï¸" FontSize="14" />
                    <TextBlock Text="Arch Info" FontSize="12" Margin="4,0,0,0"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                               VerticalAlignment="Center" />
                </StackPanel>
            </Button>
        </Grid>
    </Grid>
</UserControl>
